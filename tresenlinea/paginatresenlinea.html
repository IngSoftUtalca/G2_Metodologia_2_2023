<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" type="text/css" href="tresenlinea.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
</head>
<body style="margin-right:24% ; margin-top:10%; display:flex;align-items: center">
    <div>
        <a href="../pagina_juegos/paginajuegos.html" title="Librería de juegos">
            <button class="buttonBack-layout" tittle="Librería de juegos">Back</button>
        </a>
    </div>
    <div id="phaser-container"></div>
    <script>
        // variable global (prueba)
        let modalidadSeleccionada = null;
        let figuraSeleccionada = null;

        class Inicio extends Phaser.Scene{
            constructor() {
                super('Inicio'); // 'Menu_modalidad' es la clave única de esta escena
            }
            preload() {
                this.load.image('fondo.', 'fondotres.png');
            }
            create(){
                const backgroundImage = this.add.image(0, 0, 'fondo.').setOrigin(0).setDepth(0);
                backgroundImage.setDisplaySize(this.game.config.width, this.game.config.height)
               
                var titulo = this.add.text(250, 100, '¡Tres en linea! ', { 
                    font: '85px Georgia', 
                    fill: 'white', 
                     backgroundColor: '#1D1D1B' });
                
                var boton_incio = this.add.text(515, 400, 'Iniciar ', { font: '55px Courier New', 
                                                                       fill: 'black',
                                                                      backgroundColor: '#D9D9D9'
                                                                    })
                    .setOrigin(0.5).setInteractive({ useHandCursor: true })
                    .setInteractive().on('pointerdown', () => {
                        this.scene.start('Menu_modalidad');
                    });
                    //Animación de pulsación
                    this.tweens.add({
                        targets: boton_incio,
                        scaleX: 1.2,
                        scaleY: 1.2,
                        ease: 'Linear',
                        duration: 500,
                        repeat: -1, // Repite la animación infinitamente
                        yoyo: true // Hace que la animación vuelva a su estado original
                    });
            }

        }

        class Menu_modalidad extends Phaser.Scene {
            constructor() {
                super('Menu_modalidad'); // 'Menu_modalidad' es la clave única de esta escena
            }

            preload() {
                this.load.image('fondo.', 'fondotres.jpg');
            }

            create() {
                const backgroundImage = this.add.image(0, 0, 'fondo.').setOrigin(0).setDepth(0);
                backgroundImage.setDisplaySize(this.game.config.width, this.game.config.height)
               
                var option1 = this.add.text(260, 100, ' Elige una modalidad ', { font: '60px Giorgia', fill: 'white', backgroundColor:'#1D1D1B' });

                // botones
                var option1 = this.add.text(525, 300, 'Jugador vs Jugador', { font: '40px Courier New', fill: '#fff', backgroundColor:'#1D1D1B'  })
                    .setOrigin(0.5).setInteractive({ useHandCursor: true })
                    .setInteractive().on('pointerdown', () => {
                        modalidadSeleccionada = 'Jugador vs Jugador';
                        this.scene.start('Escena_seleccionfigura');
                    });

                var option2 = this.add.text(525, 400, 'Jugador vs Máquina', { font: '40px Courier New', fill: '#fff', backgroundColor:'#1D1D1B'  })
                    .setOrigin(0.5).setInteractive({ useHandCursor: true })
                    .setInteractive().on('pointerdown', () => {
                        modalidadSeleccionada = 'Jugador vs Maquina';
                        this.scene.start('Escena_seleccionfigura')});

                // pa que se puedan seleccionar
                option2.on('pointerup', function () {
                    console.log('Has seleccionado la Opción 2');

                });
            }
        }

        class Escena_jvj extends Phaser.Scene{
            constructor() {
                super('Escena_jvj'); // 'Escena_jvj' es la clave única de esta escena
            }

            create(){
                var menu_principal = this.add.text(100, 50, 'Inicio', { font: '35px Giorgia', fill: '#fff', backgroundColor:'#1D1D1B'  })
                    .setOrigin(0.5).setInteractive({ useHandCursor: true })
                    .setInteractive().on('pointerdown', () => {this.scene.start('Inicio')});
                this.cameras.main.setBackgroundColor('#1D1D1B'); //ajustar el color del fondo
                var graphics = this.add.graphics();
                graphics.lineStyle(1, 0xFFFFFF, 1.0);
                graphics.strokeRect(55, 30, 90, menu_principal.height);

                var menu_principal = this.add.text(900, 50, 'Reiniciar', { font: '35px Giorgia', fill: '#fff', backgroundColor:'#1D1D1B'  })
                    .setOrigin(0.5).setInteractive({ useHandCursor: true })
                    .setInteractive().on('pointerdown', () => {this.scene.start('Escena_jvj')});
                this.cameras.main.setBackgroundColor('#1D1D1B'); //ajustar el color del fondo
                var graphics = this.add.graphics();
                graphics.lineStyle(1, 0xFFFFFF, 1.0);
                graphics.strokeRect(830, 30, 140, menu_principal.height);

                this.cameras.main.setBackgroundColor('#1D1D1B'); //ajustar el color del fondo

                let graphics1 = this.add.graphics();
                graphics1.lineStyle(25, '#262624'); // grosor y color del borde de la ventana
                graphics1.strokeRect(0, 0, this.game.config.width, this.game.config.height); // Dibuja el borde

                this.crea_tablero(); // se dibuja el tablero de juego

                let texto = this.add.text(500, 150, 'Turno actual:', { font: '55px Georgia', fill: 'white', fontStyle: 'bold' });

                var self = this; // Guardar el contexto de 'this'

                //const particles = this.add.particles(500, 500, 'blue', {
                    //speed: 100,
                    //scale: { start: 1, end: 0 },
                    //blendMode: 'ADD'
                //});

                // Circulo invisible rebotando de fondo, que se hará visible en caso de que gane el O
                var circulo_rebotando = self.add.graphics({ lineStyle: { width: 10, color: 0xD9326F } });
                this.dibuja_O(0,0, circulo_rebotando);
                const circulo = self.physics.add.existing(circulo_rebotando);
                circulo.body.setVelocity(200, 300);
                circulo.body.setBounce(1, 1);
                circulo.body.setCollideWorldBounds(true);
                circulo_rebotando.setVisible(false);

                // Cruz invisible rebotando de fondo, que se hará visible en caso de que gane la X
                var cruz_rebotando = self.add.graphics({ lineStyle: { width: 10, color: '0xCC9900' } });
                this.dibuja_X(0,0, cruz_rebotando);
                const cruz = self.physics.add.existing(cruz_rebotando);
                cruz.body.setVelocity(200, 300);
                cruz.body.setBounce(1, 1);
                cruz.body.setCollideWorldBounds(true);
                cruz_rebotando.setVisible(false);

                //matriz bidimensional que representa el tablero de juego
                let tablero = [
                    [1,1,1],
                    [1,1,1],
                    [1,1,1]
                ]

                var contador = 0;

                var turnoX; //booleano que determina qué figura toca dibujar
                if(figuraSeleccionada == 'x'){
                    turnoX = true;
                }else{
                    turnoX = false;
                }

                var ganador = 0;
                var verifica = [0,0];
                var fila;
                var columna;
                var x_centrado;
                var y_centrado;
                let x;
                let y;
                var figura_turno_X = self.add.graphics({ lineStyle: { width: 10, color: 0xCC9900} });
                var figura_turno_O = self.add.graphics({ lineStyle: { width: 10, color: 0xD9326F} });
                let texto_ganador;
                if(turnoX){
                    self.dibuja_X(880, 180, figura_turno_X);
                }else{
                    self.dibuja_O(880, 180, figura_turno_O);
                }

                self.input.on('pointerdown', function (pointer) { //evento que detecta el click
                    if(contador < 9){
                        x = pointer.x;
                        y = pointer.y;
                        fila = self.determina_fila(y);
                        columna = self.determina_columna(x);
                        if(fila!=-1 && columna !=-1){ //Verifica que la posición en donde se hizo click esté dentro del tablero

                            //centra las coordenadas del click para que la figura se dibuje en el centro de la celda
                            x_centrado = self.centra_X(columna);
                            y_centrado = self.centra_Y(fila);

                            //verifica que la celda seleccionada no esté ocupada
                            if(tablero[fila][columna]==1){
                                if(turnoX){
                                    //Dibuja la cruz
                                    var lienzo = self.add.graphics({ lineStyle: { width: 10, color: 0xCC9900 } });
                                    self.dibuja_X(x_centrado, y_centrado, lienzo);

                                    tablero[fila][columna]= 'x';
                                    figura_turno_X.clear();
                                    self.dibuja_O(880, 180, figura_turno_O);
                                    
                                    turnoX = false;
                                }
                                else{
                                    //Dibujo el circulo
                                    var figura = self.add.graphics({ lineStyle: { width: 10, color: 0xD9326F } });
                                    self.dibuja_O(x_centrado, y_centrado, figura);
                                    tablero[fila][columna]= 'o';

                                    figura_turno_O.clear();
                                    self.dibuja_X(880, 180, figura_turno_X);

                                    turnoX = true;
                                }
                                contador++;

                                verifica = self.verifica_ganador(tablero);
                                
                                if(verifica[0]!= 0){

                                    var color_linea;
                                    if (verifica[1]=='x') {color_linea = 0xCC9900;}
                                    else {color_linea =0xD9326F};

                                    self.linea_ganador(verifica[0],color_linea)

                                    if(verifica[1]=='x'){
                                        let texto_ganador1 = self.add.text(550, 300, '¡Ha ganado! ', { font: '70px Georgia', fill: 'Goldenrod', fontStyle: 'bold' });
                                        var lienzo = self.add.graphics({ lineStyle: { width: 10, color: 0xCC9900 } });
                                        self.dibuja_X(730, 450, lienzo);
                                        cruz_rebotando.setVisible(true);

                                        console.log('ha ganado la X');
                                    }else{
                                        let texto_ganador2 = self.add.text(550, 300, '¡Ha ganado! ', { font: '70px Georgia', fill: '#D9326F', fontStyle: 'bold' });
                                        var lienzo = self.add.graphics({ lineStyle: { width: 10, color: 0xD9326F} });
                                        self.dibuja_O(730, 450, lienzo);
                                        circulo_rebotando.setVisible(true);
                                        console.log('ha ganado el O');
                                    }

                                    contador = 9;
                                }

                                if(contador == 9){
                                    if(turnoX){
                                        figura_turno_X.clear();
                                        
                                    }else{
                                        figura_turno_O.clear();
                                    }
                                }


                            }
                        }    
                    }
                    var verifica2 = self.verifica_ganador(tablero);
                    if(contador>=9 && verifica[1]=='0'){
                        figura_turno_X.clear();
                        figura_turno_O.clear();
                        let texto_empate = self.add.text(550, 300, '¡Empate! ', { font: '70px Georgia', fill: '#FFFFFF', fontStyle: 'bold' });
                    }
                });

            }

            crea_tablero(){
                let linea1 = this.add.graphics().lineStyle(10, 0xFFFFFF);
                linea1.beginPath();
                linea1.moveTo(180, 100);
                linea1.lineTo(180, 500);
                linea1.closePath();
                linea1.strokePath();

                let linea2 = this.add.graphics().lineStyle(10, 0xFFFFFF);
                linea2.beginPath();
                linea2.moveTo(310, 100);
                linea2.lineTo(310, 500);
                linea2.closePath();
                linea2.strokePath();

                let linea3 = this.add.graphics().lineStyle(10, 0xFFFFFF);
                linea3.beginPath();
                linea3.moveTo(45, 235);
                linea3.lineTo(445, 235);
                linea3.closePath();
                linea3.strokePath();

                let linea4 = this.add.graphics().lineStyle(10, 0xFFFFFF);
                linea4.beginPath();
                linea4.moveTo(45, 365);
                linea4.lineTo(445, 365);
                linea4.closePath();
                linea4.strokePath();
            }

            dibuja_X(x,y,lienzo){
                var tamano = 40; // Tamaño de la "X"

                // Dibujar la primera línea de la "X"
                lienzo.beginPath();
                lienzo.moveTo(x - tamano, y - tamano);
                lienzo.lineTo(x + tamano, y + tamano);
                lienzo.strokePath();

                // Dibujar la segunda línea de la "X"
                lienzo.beginPath();
                lienzo.moveTo(x + tamano, y - tamano);
                lienzo.lineTo(x - tamano, y + tamano);
                lienzo.strokePath();

            }

            dibuja_O(x,y, figura){
                var circulo = new Phaser.Geom.Circle(x, y, 40); // Crear un círculo
                figura.strokeCircleShape(circulo); // Dibujar el círculo
            }

            determina_columna(x){
                if(x > 45 && x < 445  ){ //verifica si el valor del eje x está dentro de los límites del tablero
                    if(x < 180){
                        return 0;
                    }
                    else if(x<310){
                        return 1;
                    }
                    else if(x<445){
                        return 2;
                    }
                }else{
                    return -1;
                }
            }

            determina_fila(y){
                if(y > 100 && y < 500  ){ //verifica si el valor del eje y está dentro de los límites del tablero
                    if(y < 235){return 0;}
                    if(y < 365){return 1;}
                    if(y < 500){return 2;}
                }
                else{return -1;}                
            }

            centra_X(columna){
                if(columna == 0) {return 112.5;}
                if(columna == 1) {return 245;}
                if(columna == 2) {return 377.5;}
            }

            centra_Y(fila){
                if(fila == 0) {return 167.5;}
                if(fila == 1) {return 300;}
                if(fila == 2) {return 432.5;}
            }

            verifica_ganador(tablero){

                //arreglo que contiene la información del número de la forma en qué se ganó (8 posibles formas de ganar), y cuál figura ganó
                var info = [0,'0'];


                //Verifica fila por fila si hay algún ganador
                if((tablero[0][0]!=1)&&(tablero[0][0]==tablero[0][1] && tablero[0][1]==tablero[0][2])){ //fila 0
                    info[0] = 1;
                    if(tablero[0][0]=='x'){
                        info[1] = 'x';
                        return info;
                    }else{
                        info[1] = 'o';
                        return info;
                    }
                }
                if((tablero[1][0]!=1)&&(tablero[1][0]==tablero[1][1] && tablero[1][1]==tablero[1][2])){ //fila 1
                    info[0] = 2;
                    if(tablero[1][0]=='x'){
                        info[1] = 'x';
                        return info;
                    }else{
                        info[1] = 'o';
                        return info;
                    }
                }
                if((tablero[2][0]!=1)&&(tablero[2][0]==tablero[2][1] && tablero[2][1]==tablero[2][2])){ //fila 2
                    info[0] = 3;
                    if(tablero[2][0]=='x'){
                        info[1] = 'x';
                        return info;
                    }else{
                        info[1] = 'o';
                        return info;
                    }
                }

                //Verifica columna por columna si hay algún ganador
                if((tablero[0][0]!=1)&&(tablero[0][0]==tablero[1][0] && tablero[1][0]==tablero[2][0])){ //columna 0
                    info[0] = 4;
                    if(tablero[0][0]=='x'){
                        info[1] = 'x';
                        return info;
                    }else{
                        info[1] = 'o';
                        return info;
                    }
                }
                if((tablero[0][1]!=1)&&(tablero[0][1]==tablero[1][1] && tablero[1][1]==tablero[2][1])){ //columna 1
                    info[0] = 5;
                    if(tablero[0][1]=='x'){
                        info[1] = 'x';
                        return info;
                    }else{
                        info[1] = 'o';
                        return info;
                    }
                }
                if((tablero[0][2]!=1)&&(tablero[0][2]==tablero[1][2] && tablero[1][2]==tablero[2][2])){ //columna 2
                    info[0] = 6;
                    if(tablero[0][2]=='x'){
                        info[1] = 'x';
                        return info;
                    }else{
                        info[1] = 'o';
                        return info;
                    }
                }

                //Verifica las diagonales para ver si hay algún ganador
                if((tablero[0][0]!=1)&&(tablero[0][0]==tablero[1][1] && tablero[1][1]==tablero[2][2])){ //columna 0
                    info[0] = 7;
                    if(tablero[0][0]=='x'){
                        info[1] = 'x';
                        return info;
                    }else{
                        info[1] = 'o';
                        return info;
                    }
                }
                if((tablero[0][2]!=1)&&(tablero[0][2]==tablero[1][1] && tablero[1][1]==tablero[2][0])){ //columna 1
                    info[0] = 8;
                    if(tablero[0][2]=='x'){
                        info[1] = 'x';
                        return info;
                    }else{
                        info[1] = 'o';
                        return info;
                    }
                }
                return info;
            }

            linea_ganador(caso_ganador, color){

                let linea1 = this.add.graphics().lineStyle(10, color);
                linea1.beginPath();

                switch(caso_ganador){
                    case 1: //fila 0
                        linea1.moveTo(45, 167.5);
                        linea1.lineTo(445, 167.5);
                        break;
                    case 2: //fila 1
                        linea1.moveTo(45, 300);
                        linea1.lineTo(445, 300);
                        break;
                    case 3: //fila 2
                        linea1.moveTo(45, 432.5);
                        linea1.lineTo(445, 432.5);
                        break;

                    case 4: //columna 0
                        linea1.moveTo(112.5, 100);
                        linea1.lineTo(112.5, 500);    
                        break;
                    case 5: //columna 1
                        linea1.moveTo(245, 100);
                        linea1.lineTo(245, 500);
                        break;
                    case 6: //columna 2
                        linea1.moveTo(377.5, 100);
                        linea1.lineTo(377.5, 500);
                        break;

                    case 7: //primera diagonal
                        linea1.moveTo(45, 100);
                        linea1.lineTo(445, 500);
                        break;
                    case 8: //segunda diagonal
                        linea1.moveTo(45, 500);
                        linea1.lineTo(445, 100);
                        break;                                    
                }
                linea1.closePath();
                linea1.strokePath();
            }
            
            texto_ganador(figura_ganadora){
                let texto;
                if(figura_ganadora=='x'){
                    texto = this.add.text(500, 600, 'Ha ganado la X', { font: '55px Arial', fill: 'Goldenrod', fontStyle: 'bold' });
                    console.log('ha ganado la X');
                }else{
                    texto = this.add.text(500, 600, 'Ha ganado el O', { font: '55px Arial', fill: 'Dark Pink', fontStyle: 'bold' });
                    console.log('ha ganado el O');
                }
            }
        }

        class Escena_seleccionfigura extends Phaser.Scene{
            constructor() {
                super('Escena_seleccionfigura'); // seleccionfigura' es la clave única de esta escena
            }
            preload() {
                this.load.image('fondo.', 'fondotres.jpg');
            }
            create(){
                const backgroundImage = this.add.image(0, 0, 'fondo.').setOrigin(0).setDepth(0);
                backgroundImage.setDisplaySize(this.game.config.width, this.game.config.height)
               
                let graphics1 = this.add.graphics();
                graphics1.lineStyle(5, 0xCC9900); // grosor y color del borde
                graphics1.strokeRect(0, 0, this.game.config.width, this.game.config.height); // Dibuja el borde

                if(modalidadSeleccionada== 'Jugador vs Jugador'){
                    var option1 = this.add.text(70, 65, 'Selecciona la figura que comienza el juego', { font: '50px Georgia', fill: '#fff', backgroundColor:'#1D1D1B'});

                }else if(modalidadSeleccionada == 'Jugador vs Maquina'){
                    var option1 = this.add.text(300, 65, 'Selecciona tu figura ', { font: '55px Georgia', fill: '#fff', backgroundColor:'#1D1D1B' });
                }


                // botones
                var option1 = this.add.text(525, 300, 'Cruz ', { font: '50px Georgia', fill: 'Goldenrod', backgroundColor:'#1D1D1B' })
                    .setOrigin(0.5).setInteractive({ useHandCursor: true })
                    .setInteractive().on('pointerdown', () => {
                        figuraSeleccionada = 'x';
                        if(modalidadSeleccionada == 'Jugador vs Jugador'){
                            this.scene.start('Escena_jvj');
                            console.log('jugador vs jugador');
                        }else{
                            this.scene.start('Escena_jvm');
                            console.log('jugador vs maquina');
                        }
                    });

                var option2 = this.add.text(525, 400, 'Círculo ', { font: '50px Georgia', fill: '#D9326F',backgroundColor:'#1D1D1B' })
                    .setOrigin(0.5).setInteractive({ useHandCursor: true })
                    .setInteractive().on('pointerdown', () => {
                        figuraSeleccionada = 'o';
                        if(modalidadSeleccionada == 'Jugador vs Jugador'){
                            this.scene.start('Escena_jvj');
                            console.log('jugador vs jugador');
                        }else{
                            this.scene.start('Escena_jvm');
                            console.log('jugador vs maquina');
                        }
                    
                    });
            }
        }

        class Escena_jvm extends Phaser.Scene{
            constructor() {
                super('Escena_jvm'); // 'Escena_jvm' es la clave única de esta escena
            }

            create(){
                var menu_principal = this.add.text(100, 50, 'Inicio', { font: '35px Giorgia', fill: '#fff', backgroundColor:'#1D1D1B'  })
                    .setOrigin(0.5).setInteractive({ useHandCursor: true })
                    .setInteractive().on('pointerdown', () => {this.scene.start('Inicio')});
                this.cameras.main.setBackgroundColor('#1D1D1B'); //ajustar el color del fondo
                var graphics = this.add.graphics();
                graphics.lineStyle(1, 0xFFFFFF, 1.0);
                graphics.strokeRect(55, 30, 90, menu_principal.height);

                var menu_principal = this.add.text(900, 50, 'Reiniciar', { font: '35px Giorgia', fill: '#fff', backgroundColor:'#1D1D1B'  })
                    .setOrigin(0.5).setInteractive({ useHandCursor: true })
                    .setInteractive().on('pointerdown', () => {this.scene.start('Escena_jvm')});
                this.cameras.main.setBackgroundColor('#1D1D1B'); //ajustar el color del fondo
                var graphics = this.add.graphics();
                graphics.lineStyle(1, 0xFFFFFF, 1.0);
                graphics.strokeRect(830, 30, 140, menu_principal.height);

                let graphics1 = this.add.graphics();
                graphics1.lineStyle(25, 'gray'); // grosor y color del borde de la ventana
                graphics1.strokeRect(0, 0, this.game.config.width, this.game.config.height); // Dibuja el borde

                this.crea_tablero(); // se dibuja el tablero de juego

                let texto = this.add.text(500, 150, 'Turno actual:', { font: '60px Georgia', fill: '#FFFFFF', fontStyle: 'bold' });

                var self = this; // Guardar el contexto de 'this'

                //const particles = this.add.particles(500, 500, 'blue', {
                    //speed: 100,
                    //scale: { start: 1, end: 0 },
                    //blendMode: 'ADD'
                //});

                // Circulo invisible rebotando de fondo, que se hará visible en caso de que gane el O
                var circulo_rebotando = self.add.graphics({ lineStyle: { width: 10, color: 0xD9326F } });
                this.dibuja_O(0,0, circulo_rebotando);
                const circulo = self.physics.add.existing(circulo_rebotando);
                circulo.body.setVelocity(200, 300);
                circulo.body.setBounce(1, 1);
                circulo.body.setCollideWorldBounds(true);
                circulo_rebotando.setVisible(false);

                // Cruz invisible rebotando de fondo, que se hará visible en caso de que gane la X
                var cruz_rebotando = self.add.graphics({ lineStyle: { width: 10, color: 0xCC9900 } });
                this.dibuja_X(0,0, cruz_rebotando);
                const cruz = self.physics.add.existing(cruz_rebotando);
                cruz.body.setVelocity(200, 300);
                cruz.body.setBounce(1, 1);
                cruz.body.setCollideWorldBounds(true);
                cruz_rebotando.setVisible(false);

                //matriz bidimensional que representa el tablero de juego
                let tablero = [
                    [1,1,1],
                    [1,1,1],
                    [1,1,1]
                ]

                var contador = 0;

                var turnoX; //booleano que determina qué figura toca dibujar
                if(figuraSeleccionada == 'x'){
                    turnoX = true;
                }else{
                    turnoX = false;
                }
                
                var ganador = 0;
                var verifica = [0,0];
                var fila;
                var columna;
                var x_centrado;
                var y_centrado;
                let x;
                let y;
                var figura_turno_X = self.add.graphics({ lineStyle: { width: 10, color: 0xCC9900} });
                var figura_turno_O = self.add.graphics({ lineStyle: { width: 10, color: 0xD9326F} });
                let texto_ganador;
                if(figuraSeleccionada=='x'){
                    self.dibuja_X(920, 180, figura_turno_X);
                }else{
                    self.dibuja_O(920, 180, figura_turno_O);
                }

                self.input.on('pointerdown', function (pointer) { //evento que detecta el click
                    if(contador < 9){
                        x = pointer.x;
                        y = pointer.y;
                        fila = self.determina_fila(y);
                        columna = self.determina_columna(x);
                        if(fila!=-1 && columna !=-1){ //Verifica que la posición en donde se hizo click esté dentro del tablero

                            //verifica que la celda seleccionada no esté ocupada
                            if(tablero[fila][columna]==1){

                                //centra las coordenadas del click para que la figura se dibuje en el centro de la celda
                                x_centrado = self.centra_X(columna);
                                y_centrado = self.centra_Y(fila);

                                var jugada_maquina;

                                if(figuraSeleccionada=='x'){
                                    //Dibuja la cruz
                                    var lienzo = self.add.graphics({ lineStyle: { width: 10, color: 0xCC9900 } });
                                    self.dibuja_X(x_centrado, y_centrado, lienzo);

                                    tablero[fila][columna]= 'x';
                                    figura_turno_X.clear();
                                    self.dibuja_O(920, 180, figura_turno_O);

                                    //Luego de cada jugada se verifica si hay algún ganador
                                    verifica = self.verifica_ganador(tablero);
                                
                                    if(verifica[0]!= 0){
                                        figura_turno_X.clear();
                                        figura_turno_O.clear();
                                        var color_linea;
                                        if (verifica[1]=='x') {color_linea = 0xCC9900;}
                                        else {color_linea = 0xD9326F};

                                        self.linea_ganador(verifica[0],color_linea)

                                        if(verifica[1]=='x'){
                                            let texto_ganador1 = self.add.text(550, 300, '¡Ha ganado!', { font: '70px Georgia', fill: '0xCC9900', fontStyle: 'bold' });
                                            var lienzo = self.add.graphics({ lineStyle: { width: 10, color: 0xCC9900 } });
                                            self.dibuja_X(730, 450, lienzo);
                                            cruz_rebotando.setVisible(true);

                                            console.log('ha ganado la X');
                                        }else{
                                            let texto_ganador2 = self.add.text(550, 300, '¡Ha ganado!', { font: '70px Georgia', fill: '#D9326F', fontStyle: 'bold' });
                                            var lienzo = self.add.graphics({ lineStyle: { width: 10, color: 0xD9326F } });
                                            self.dibuja_O(730, 450, lienzo);
                                            circulo_rebotando.setVisible(true);
                                            console.log('ha ganado el O');
                                        }

                                        contador = 9;
                                    }

                                    if(contador<9){
                                        // Pausa por 2 segundos
                                        setTimeout(function() {
                                            //Dibujo el circulo
                                            var figura = self.add.graphics({ lineStyle: { width: 10, color: 0xD9326F } });

                                            jugada_maquina=self.analiza_jugada(tablero, 'o')

                                            self.dibuja_O(self.centra_X(jugada_maquina[1]), self.centra_Y(jugada_maquina[0]), figura);
                                            tablero[jugada_maquina[0]][jugada_maquina[1]]= 'o';

                                            figura_turno_O.clear();
                                            self.dibuja_X(920, 180, figura_turno_X);
                                                //Luego de cada jugada se verifica si hay algún ganador
                                            verifica = self.verifica_ganador(tablero);

                                            if(verifica[0]!= 0){
                                                figura_turno_X.clear();
                                                figura_turno_O.clear();
                                                var color_linea;
                                                if (verifica[1]=='x') {color_linea = 0xCC9900;}
                                                else {color_linea = 0xD9326F};

                                                self.linea_ganador(verifica[0],color_linea)

                                                if(verifica[1]=='x'){
                                                    let texto_ganador1 = self.add.text(550, 300, '¡Ha ganado!', { font: '70px Georgia', fill: '0xCC9900', fontStyle: 'bold' });
                                                    var lienzo = self.add.graphics({ lineStyle: { width: 10, color: 0xCC9900 } });
                                                    self.dibuja_X(730, 450, lienzo);
                                                    cruz_rebotando.setVisible(true);

                                                    console.log('ha ganado la X');
                                                }else{
                                                    let texto_ganador2 = self.add.text(550, 300, '¡Ha ganado!', { font: '70px Georgia', fill: '#D9326F', fontStyle: 'bold' });
                                                    var lienzo = self.add.graphics({ lineStyle: { width: 10, color: 0xD9326F } });
                                                    self.dibuja_O(730, 450, lienzo);
                                                    circulo_rebotando.setVisible(true);
                                                    console.log('ha ganado el O');
                                                }

                                                contador = 9;
                                            }
                                        }, 10);
                                    }
                                }
                                else if(figuraSeleccionada=='o'){
                                    //Dibujo el circulo
                                    var figura = self.add.graphics({ lineStyle: { width: 10, color: 0xD9326F} });
                                    self.dibuja_O(x_centrado, y_centrado, figura);
                                    tablero[fila][columna]= 'o';

                                    figura_turno_O.clear();
                                    self.dibuja_X(920, 180, figura_turno_X);

                                    //Luego de cada jugada se verifica si hay algún ganador
                                    verifica = self.verifica_ganador(tablero);
                                    
                                    if(verifica[0]!= 0){
                                        figura_turno_X.clear();
                                        figura_turno_O.clear();
                                        var color_linea;
                                        if (verifica[1]=='x') {color_linea = 0xCC9900;}
                                        else {color_linea = 0xD9326F};

                                        self.linea_ganador(verifica[0],color_linea)

                                        if(verifica[1]=='x'){
                                            let texto_ganador1 = self.add.text(550, 300, '¡Ha ganado!', { font: '70px Georgia', fill: '0xCC9900', fontStyle: 'bold' });
                                            var lienzo = self.add.graphics({ lineStyle: { width: 10, color: 0xCC9900 } });
                                            self.dibuja_X(730, 450, lienzo);
                                            cruz_rebotando.setVisible(true);
                                        }else{
                                            let texto_ganador2 = self.add.text(550, 300, '¡Ha ganado!', { font: '70px Georgia', fill: '#D9326F', fontStyle: 'bold' });
                                            var lienzo = self.add.graphics({ lineStyle: { width: 10, color: 0xD9326F } });
                                            self.dibuja_O(730, 450, lienzo);
                                            circulo_rebotando.setVisible(true);
                                        }

                                        contador = 9;
                                    }

                                    if(contador!=9){
                                        // Pausa por 2 segundos
                                        setTimeout(function() {
                                            //Dibuja la cruz
                                            var figura = self.add.graphics({ lineStyle: { width: 10, color: 0xCC9900 } });

                                            jugada_maquina=self.analiza_jugada(tablero, 'x')

                                            self.dibuja_X(self.centra_X(jugada_maquina[1]), self.centra_Y(jugada_maquina[0]), figura);
                                            tablero[jugada_maquina[0]][jugada_maquina[1]]= 'x';

                                            figura_turno_X.clear();
                                            self.dibuja_O(920, 180, figura_turno_O);
                                            //Luego de cada jugada se verifica si hay algún ganador
                                            verifica = self.verifica_ganador(tablero);

                                            if(verifica[0]!= 0){
                                                figura_turno_X.clear();
                                                figura_turno_O.clear();
                                                var color_linea;
                                                if (verifica[1]=='x') {color_linea = 0xCC9900;}
                                                else {color_linea = 0xD9326F};

                                                self.linea_ganador(verifica[0],color_linea)

                                                if(verifica[1]=='x'){
                                                    let texto_ganador1 = self.add.text(550, 300, '¡Ha ganado!', { font: '70px Georgia', fill: '0xCC9900', fontStyle: 'bold' });
                                                    var lienzo = self.add.graphics({ lineStyle: { width: 10, color: 0xCC9900 } });
                                                    self.dibuja_X(730, 450, lienzo);
                                                    cruz_rebotando.setVisible(true);
                                                }else{
                                                    let texto_ganador2 = self.add.text(550, 300, '¡Ha ganado!', { font: '70px Georgia', fill: '#D9326F', fontStyle: 'bold' });
                                                    var lienzo = self.add.graphics({ lineStyle: { width: 10, color: 0xD9326F } });
                                                    self.dibuja_O(730, 450, lienzo);
                                                    circulo_rebotando.setVisible(true);
                                                }

                                                contador = 9;
                                            }
                                        }, 10);
                                    }
                                }
                                contador=contador+2;
                            }
                        }    
                    }
                    var verifica2 = self.verifica_ganador(tablero);
                    if(contador>=9){
                        figura_turno_X.clear();
                        figura_turno_O.clear();
                        let texto_empate = self.add.text(550, 300, '¡Empate! ', { font: '70px Georgia', fill: '#FFFFFF', fontStyle: 'bold' });
                    }
                });

            }

            crea_tablero(){
                let linea1 = this.add.graphics().lineStyle(10, 0xFFFFFF);
                linea1.beginPath();
                linea1.moveTo(180, 100);
                linea1.lineTo(180, 500);
                linea1.closePath();
                linea1.strokePath();

                let linea2 = this.add.graphics().lineStyle(10, 0xFFFFFF);
                linea2.beginPath();
                linea2.moveTo(310, 100);
                linea2.lineTo(310, 500);
                linea2.closePath();
                linea2.strokePath();

                let linea3 = this.add.graphics().lineStyle(10, 0xFFFFFF);
                linea3.beginPath();
                linea3.moveTo(45, 235);
                linea3.lineTo(445, 235);
                linea3.closePath();
                linea3.strokePath();

                let linea4 = this.add.graphics().lineStyle(10, 0xFFFFFF);
                linea4.beginPath();
                linea4.moveTo(45, 365);
                linea4.lineTo(445, 365);
                linea4.closePath();
                linea4.strokePath();
            }

            dibuja_X(x,y,lienzo){
                var tamano = 40; // Tamaño de la "X"

                // Dibujar la primera línea de la "X"
                lienzo.beginPath();
                lienzo.moveTo(x - tamano, y - tamano);
                lienzo.lineTo(x + tamano, y + tamano);
                lienzo.strokePath();

                // Dibujar la segunda línea de la "X"
                lienzo.beginPath();
                lienzo.moveTo(x + tamano, y - tamano);
                lienzo.lineTo(x - tamano, y + tamano);
                lienzo.strokePath();

            }

            dibuja_O(x,y, figura){
                var circulo = new Phaser.Geom.Circle(x, y, 40); // Crear un círculo
                figura.strokeCircleShape(circulo); // Dibujar el círculo
            }

            determina_columna(x){
                if(x > 45 && x < 445  ){ //verifica si el valor del eje x está dentro de los límites del tablero
                    if(x < 180){
                        return 0;
                    }
                    else if(x<310){
                        return 1;
                    }
                    else if(x<445){
                        return 2;
                    }
                }else{
                    return -1;
                }
            }

            determina_fila(y){
                if(y > 100 && y < 500  ){ //verifica si el valor del eje y está dentro de los límites del tablero
                    if(y < 235){return 0;}
                    if(y < 365){return 1;}
                    if(y < 500){return 2;}
                }
                else{return -1;}                
            }

            centra_X(columna){
                if(columna == 0) {return 112.5;}
                if(columna == 1) {return 245;}
                if(columna == 2) {return 377.5;}
            }

            centra_Y(fila){
                if(fila == 0) {return 167.5;}
                if(fila == 1) {return 300;}
                if(fila == 2) {return 432.5;}
            }

            verifica_ganador(tablero){

                //arreglo que contiene la información del número de la forma en qué se ganó (8 posibles formas de ganar), y cuál figura ganó
                var info = [0,'0'];


                //Verifica fila por fila si hay algún ganador
                if((tablero[0][0]!=1)&&(tablero[0][0]==tablero[0][1] && tablero[0][1]==tablero[0][2])){ //fila 0
                    info[0] = 1;
                    if(tablero[0][0]=='x'){
                        info[1] = 'x';
                        return info;
                    }else{
                        info[1] = 'o';
                        return info;
                    }
                }
                if((tablero[1][0]!=1)&&(tablero[1][0]==tablero[1][1] && tablero[1][1]==tablero[1][2])){ //fila 1
                    info[0] = 2;
                    if(tablero[1][0]=='x'){
                        info[1] = 'x';
                        return info;
                    }else{
                        info[1] = 'o';
                        return info;
                    }
                }
                if((tablero[2][0]!=1)&&(tablero[2][0]==tablero[2][1] && tablero[2][1]==tablero[2][2])){ //fila 2
                    info[0] = 3;
                    if(tablero[2][0]=='x'){
                        info[1] = 'x';
                        return info;
                    }else{
                        info[1] = 'o';
                        return info;
                    }
                }

                //Verifica columna por columna si hay algún ganador
                if((tablero[0][0]!=1)&&(tablero[0][0]==tablero[1][0] && tablero[1][0]==tablero[2][0])){ //columna 0
                    info[0] = 4;
                    if(tablero[0][0]=='x'){
                        info[1] = 'x';
                        return info;
                    }else{
                        info[1] = 'o';
                        return info;
                    }
                }
                if((tablero[0][1]!=1)&&(tablero[0][1]==tablero[1][1] && tablero[1][1]==tablero[2][1])){ //columna 1
                    info[0] = 5;
                    if(tablero[0][1]=='x'){
                        info[1] = 'x';
                        return info;
                    }else{
                        info[1] = 'o';
                        return info;
                    }
                }
                if((tablero[0][2]!=1)&&(tablero[0][2]==tablero[1][2] && tablero[1][2]==tablero[2][2])){ //columna 2
                    info[0] = 6;
                    if(tablero[0][2]=='x'){
                        info[1] = 'x';
                        return info;
                    }else{
                        info[1] = 'o';
                        return info;
                    }
                }

                //Verifica las diagonales para ver si hay algún ganador
                if((tablero[0][0]!=1)&&(tablero[0][0]==tablero[1][1] && tablero[1][1]==tablero[2][2])){ //columna 0
                    info[0] = 7;
                    if(tablero[0][0]=='x'){
                        info[1] = 'x';
                        return info;
                    }else{
                        info[1] = 'o';
                        return info;
                    }
                }
                if((tablero[0][2]!=1)&&(tablero[0][2]==tablero[1][1] && tablero[1][1]==tablero[2][0])){ //columna 1
                    info[0] = 8;
                    if(tablero[0][2]=='x'){
                        info[1] = 'x';
                        return info;
                    }else{
                        info[1] = 'o';
                        return info;
                    }
                }
                return info;
            }

            linea_ganador(caso_ganador, color){

                let linea1 = this.add.graphics().lineStyle(10, color);
                linea1.beginPath();

                switch(caso_ganador){
                    case 1: //fila 0
                        linea1.moveTo(45, 167.5);
                        linea1.lineTo(445, 167.5);
                        break;
                    case 2: //fila 1
                        linea1.moveTo(45, 300);
                        linea1.lineTo(445, 300);
                        break;
                    case 3: //fila 2
                        linea1.moveTo(45, 432.5);
                        linea1.lineTo(445, 432.5);
                        break;

                    case 4: //columna 0
                        linea1.moveTo(112.5, 100);
                        linea1.lineTo(112.5, 500);    
                        break;
                    case 5: //columna 1
                        linea1.moveTo(245, 100);
                        linea1.lineTo(245, 500);
                        break;
                    case 6: //columna 2
                        linea1.moveTo(377.5, 100);
                        linea1.lineTo(377.5, 500);
                        break;

                    case 7: //primera diagonal
                        linea1.moveTo(45, 100);
                        linea1.lineTo(445, 500);
                        break;
                    case 8: //segunda diagonal
                        linea1.moveTo(45, 500);
                        linea1.lineTo(445, 100);
                        break;                                    
                }
                linea1.closePath();
                linea1.strokePath();
            }
            
            texto_ganador(figura_ganadora){
                let texto;
                if(figura_ganadora=='x'){
                    texto = this.add.text(500, 600, 'Ha ganado la X', { font: '55px Arial', fill: '0xCC9900', fontStyle: 'bold' });
                    console.log('ha ganado la X');
                }else{
                    texto = this.add.text(500, 600, 'Ha ganado el O', { font: '55px Arial', fill: '0xD9326F', fontStyle: 'bold' });
                    console.log('ha ganado el O');
                }
            }

            analiza_jugada(tablero,turno_maquina){

                var turno_jugador;
                if(turno_maquina=='x'){turno_jugador = 'o';}
                if(turno_maquina=='o'){turno_jugador = 'x';}

                //Arreglo que contendrá las coordenadas de la matriz del tablero en donde será dibujada la figura que corresponda
                var coordenadas = [0,0]

                var fila_celda_desocupada;
                var columna_celda_desocupada;
                //1.- verifica si la maquina tiene jugada ganadora
                var celdas_maquina; //contador de las celdas ocupadas por la máquina

                    // Verificar columnas
                        for(var j=0; j<3 ; j++){
                            celdas_maquina = 0;
                            var fila_celda_desocupada = i;
                            var columna_celda_desocupada = j;

                            for(var i=0; i<3; i++){
                                if(tablero[i][j]==turno_maquina){ //Consulta si la celda esta ocupada por la máquina
                                    celdas_maquina++;
                                }else{
                                    fila_celda_desocupada = i;
                                }
                            }

                            if(celdas_maquina==2 && tablero[fila_celda_desocupada][columna_celda_desocupada]==1){
                                coordenadas[0] = fila_celda_desocupada;
                                coordenadas[1] = columna_celda_desocupada;
                                return coordenadas;
                            }
                        }

                    //Verificar filas
                        for(var i=0; i<3 ; i++){
                            celdas_maquina = 0;
                            fila_celda_desocupada = i;

                            for(var j=0; j<3; j++){
                                if(tablero[i][j]==turno_maquina){ //Consulta si la celda esta ocupada por la máquina
                                    celdas_maquina++;
                                }else if(tablero[i][j]==1){
                                    columna_celda_desocupada = j;
                                }
                            }

                            if(celdas_maquina==2 && tablero[fila_celda_desocupada][columna_celda_desocupada]==1){
                                coordenadas[0] = fila_celda_desocupada;
                                coordenadas[1] = columna_celda_desocupada;
                                return coordenadas;
                            }
                        }
                    

                    //Verificar diagonales

                        //Verifica la primera diagonal
                        celdas_maquina=0;
                        for(var i = 0, j = 0; i<3 && j<3; i++, j++){ 
                            if(tablero[i][j]==turno_maquina){ //Consulta si la celda esta ocupada por la máquina
                                celdas_maquina++;
                            }else{
                                fila_celda_desocupada = i;
                                columna_celda_desocupada = j;
                            }
                        }
                        if(celdas_maquina==2 && tablero[fila_celda_desocupada][columna_celda_desocupada]==1){
                            coordenadas[0] = fila_celda_desocupada;
                            coordenadas[1] = columna_celda_desocupada;
                            return coordenadas;
                        }

                        //Verifica la segunda diagonal
                        celdas_maquina=0;
                        for(var i = 0, j = 2; i<3 && j>=0; i++, j--){
                            if(tablero[i][j]==turno_maquina){ //Consulta si la celda esta ocupada por la máquina
                                celdas_maquina++;
                            }else{
                                fila_celda_desocupada = i;
                                columna_celda_desocupada = j;
                            }
                        }
                        if(celdas_maquina==2 && tablero[fila_celda_desocupada][columna_celda_desocupada]==1){
                            coordenadas[0] = fila_celda_desocupada;
                            coordenadas[1] = columna_celda_desocupada;
                            return coordenadas;
                        }      


                //2.- verifica si el jugador tiene una jugada ganadora
                    var celdas_jugador; //contador de las celdas ocupadas por el jugador

                    // Verificar columnas
                        for(var j=0; j<3 ; j++){
                            celdas_jugador = 0;
                            var columna_celda_desocupada = j;
                            for(var i=0; i<3; i++){
                                if(tablero[i][j]==turno_jugador){ //Consulta si la celda esta ocupada por el jugador
                                    celdas_jugador++;
                                }else{
                                    fila_celda_desocupada = i;
                                }
                            }

                            if(celdas_jugador==2 && tablero[fila_celda_desocupada][columna_celda_desocupada]==1){
                                coordenadas[0] = fila_celda_desocupada;
                                coordenadas[1] = columna_celda_desocupada;
                                return coordenadas;
                            }

                        }

                    //Verificar filas
                        for(var i=0; i<3 ; i++){
                            celdas_jugador = 0;
                            var fila_celda_desocupada = i;

                            for(var j=0; j<3; j++){
                                if(tablero[i][j]==turno_jugador){ //Consulta si la celda esta ocupada por el jugador
                                    celdas_jugador++;
                                }else{
                                    columna_celda_desocupada = j;
                                }
                            }

                            if(celdas_jugador==2 && tablero[fila_celda_desocupada][columna_celda_desocupada]==1){
                                coordenadas[0] = fila_celda_desocupada;
                                coordenadas[1] = columna_celda_desocupada;
                                return coordenadas;
                            }
                        }
                    

                    //Verificar diagonales

                        //Verifica la primera diagonal
                        celdas_jugador=0;
                        for(var i = 0, j = 0; i<3 && j<3; i++, j++){ 
                            if(tablero[i][j]==turno_jugador){ //Consulta si la celda esta ocupada por el jugador
                                celdas_jugador++;
                            }else{
                                fila_celda_desocupada = i;
                                columna_celda_desocupada = j;
                            }
                        }
                        if(celdas_jugador==2 && tablero[fila_celda_desocupada][columna_celda_desocupada]==1){
                            coordenadas[0] = fila_celda_desocupada;
                            coordenadas[1] = columna_celda_desocupada;
                            return coordenadas;
                        }

                        //Verifica la segunda diagonal
                        celdas_jugador=0;
                        for(var i = 0, j = 2; i<3 && j>=0; i++, j--){
                            if(tablero[i][j]==turno_jugador){ //Consulta si la celda esta ocupada por el jugador
                                celdas_jugador++;
                            }else{
                                fila_celda_desocupada = i;
                                columna_celda_desocupada = j;
                            }
                        }
                        if(celdas_jugador==2 && tablero[fila_celda_desocupada][columna_celda_desocupada]==1){
                            coordenadas[0] = fila_celda_desocupada;
                            coordenadas[1] = columna_celda_desocupada;
                            return coordenadas;
                        }                     

                //3.- verifica si puede usar la celda del centro
                if(tablero[1][1]==1) {
                    coordenadas[0] = 1;
                    coordenadas[1] = 1;
                    return coordenadas;
                }

                //4.- verifica si puede usar una celda de una esquina
            

                if(tablero[0][0]==1) {
                    coordenadas[0] = 0;
                    coordenadas[1] = 0;
                    return coordenadas;
                }
                if(tablero[0][2]==1) {
                    coordenadas[0] = 0;
                    coordenadas[1] = 2;
                    return coordenadas;
                }
                if(tablero[2][2]==1) {
                    coordenadas[0] = 2;
                    coordenadas[1] = 2;
                    return coordenadas;
                }
                if(tablero[2][0]==1) {
                    coordenadas[0] = 2;
                    coordenadas[1] = 0;
                    return coordenadas;
                }    

                //5.- dibuja la figura en una de las celdas laterales

                if(tablero[0][1]==1) {
                    coordenadas[0] = 0;
                    coordenadas[1] = 1;
                    return coordenadas;
                }
                if(tablero[1][2]==1) {
                    coordenadas[0] = 1;
                    coordenadas[1] = 2;
                    return coordenadas;
                }
                if(tablero[2][1]==1) {
                    coordenadas[0] = 2;
                    coordenadas[1] = 1;
                    return coordenadas;
                }
                if(tablero[1][0]==1) {
                    coordenadas[0] = 1;
                    coordenadas[1] = 0;
                    return coordenadas;
                }

                return coordenadas;
            }

        }

        const config = {
            type: Phaser.AUTO,
            width: 1050,
            height: 600,
            scene: [Inicio, Menu_modalidad, Escena_seleccionfigura, Escena_jvj, Escena_jvm],
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 200 }
                }
            }
        };

        const game = new Phaser.Game(config);

    </script>
</body>
</html>
